<!-- 
    TEST CHá»¨C NÄ‚NG Sá»¬A Äá»€ THI
    Má»Ÿ file nÃ y trong trÃ¬nh duyá»‡t vÃ  má»Ÿ Console (F12) Ä‘á»ƒ test
-->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Sá»­a Äá» Thi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 30px; 
        }
        .debug-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .log {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #44aaff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="debug-card">
            <h2 class="text-primary mb-4">ğŸ” Debug Chá»©c NÄƒng Sá»­a Äá» Thi</h2>
            
            <div class="alert alert-info">
                <strong>ğŸ“ HÆ°á»›ng dáº«n:</strong>
                <ol class="mb-0">
                    <li>ÄÄƒng nháº­p vá»›i tÃ i khoáº£n giÃ¡o viÃªn</li>
                    <li>Láº¥y danh sÃ¡ch Ä‘á» thi Ä‘á»ƒ xem MÃ£ Ä‘á»</li>
                    <li>Nháº­p MÃ£ Ä‘á» vÃ  thÃ´ng tin má»›i</li>
                    <li>Click "Test Sá»­a Äá» Thi"</li>
                    <li>Xem log bÃªn dÆ°á»›i Ä‘á»ƒ debug</li>
                </ol>
            </div>

            <!-- Step 1: Login -->
            <div class="mb-4">
                <h5>BÆ°á»›c 1: ÄÄƒng nháº­p</h5>
                <div class="row">
                    <div class="col-md-3">
                        <input type="text" id="username" class="form-control" placeholder="TÃªn Ä‘Äƒng nháº­p" value="giaovien1">
                    </div>
                    <div class="col-md-3">
                        <input type="password" id="password" class="form-control" placeholder="Máº­t kháº©u" value="123456">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary w-100" onclick="testLogin()">ğŸ” ÄÄƒng nháº­p</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-info w-100" onclick="getExams()">ğŸ“‹ Láº¥y Ä‘á» thi</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Edit Exam -->
            <div class="mb-4">
                <h5>BÆ°á»›c 2: Sá»­a Ä‘á» thi</h5>
                <div class="row mb-2">
                    <div class="col-md-3">
                        <input type="text" id="maDe" class="form-control" placeholder="MÃ£ Ä‘á» (VD: DE009)">
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="tenDeMoi" class="form-control" placeholder="TÃªn Ä‘á» má»›i">
                    </div>
                    <div class="col-md-2">
                        <input type="number" id="thoiGian" class="form-control" placeholder="Thá»i gian" value="90">
                    </div>
                    <div class="col-md-3">
                        <select id="chuDe" class="form-select">
                            <option value="">-- Chá»§ Ä‘á» --</option>
                            <option value="Tin há»c Ä‘áº¡i cÆ°Æ¡ng">Tin há»c Ä‘áº¡i cÆ°Æ¡ng</option>
                            <option value="Láº­p trÃ¬nh Pascal">Láº­p trÃ¬nh Pascal</option>
                            <option value="Tá»•ng há»£p">Tá»•ng há»£p</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-warning w-100" onclick="testEditExam()">
                            âœï¸ Test Sá»­a Äá» Thi
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-secondary w-100" onclick="clearLog()">
                            ğŸ—‘ï¸ XÃ³a Log
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log Console -->
            <div>
                <h5>ğŸ“œ Log Debug</h5>
                <div id="log" class="log">
                    <div class="info">â†’ Sáºµn sÃ ng Ä‘á»ƒ test...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000/api';
        let token = '';

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logEl.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '<div class="info">â†’ Log Ä‘Ã£ Ä‘Æ°á»£c xÃ³a...</div>';
        }

        async function apiRequest(endpoint, method = 'GET', body = null) {
            log(`â†’ Gá»i API: ${method} ${endpoint}`, 'info');
            
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };

            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
                log(`â†’ Token: ${token.substring(0, 20)}...`, 'info');
            }

            if (body) {
                options.body = JSON.stringify(body);
                log(`â†’ Body: ${JSON.stringify(body)}`, 'info');
            }

            try {
                const response = await fetch(API_BASE + endpoint, options);
                log(`â† Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log(`â† Response: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
                
                return { ok: response.ok, status: response.status, data };
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
                return { ok: false, error: error.message };
            }
        }

        async function testLogin() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ” BÆ¯á»šC 1: ÄÄ‚NG NHáº¬P', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const result = await apiRequest('/login', 'POST', {
                TenDangNhap: username,
                MatKhau: password
            });

            if (result.ok && result.data.token) {
                token = result.data.token;
                log('âœ… ÄÄƒng nháº­p THÃ€NH CÃ”NG!', 'success');
                log(`â†’ Role: ${result.data.user.Role}`, 'success');
            } else {
                log('âŒ ÄÄƒng nháº­p THáº¤T Báº I!', 'error');
            }
        }

        async function getExams() {
            if (!token) {
                log('âš ï¸ Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!', 'warning');
                return;
            }

            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ“‹ Láº¤Y DANH SÃCH Äá»€ THI', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

            const result = await apiRequest('/de-thi/teacher', 'GET');

            if (result.ok && result.data.data) {
                log(`âœ… TÃ¬m tháº¥y ${result.data.data.length} Ä‘á» thi`, 'success');
                result.data.data.forEach((exam, index) => {
                    log(`  ${index + 1}. ${exam.MaDe}: ${exam.TenDe} (${exam.SoLuongCauHoi} cÃ¢u, ${exam.ThoiGianLamBai} phÃºt)`, 'success');
                });
            }
        }

        async function testEditExam() {
            if (!token) {
                log('âš ï¸ Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!', 'warning');
                return;
            }

            const maDe = document.getElementById('maDe').value;
            const tenDeMoi = document.getElementById('tenDeMoi').value;
            const thoiGian = document.getElementById('thoiGian').value;
            const chuDe = document.getElementById('chuDe').value;

            if (!maDe || !tenDeMoi) {
                log('âš ï¸ Vui lÃ²ng nháº­p MÃ£ Ä‘á» vÃ  TÃªn Ä‘á» má»›i!', 'warning');
                return;
            }

            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('âœï¸ BÆ¯á»šC 2: Sá»¬A Äá»€ THI', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

            // BÆ°á»›c 1: Láº¥y chi tiáº¿t Ä‘á» thi
            log('â†’ BÆ°á»›c 2.1: Láº¥y thÃ´ng tin Ä‘á» thi hiá»‡n táº¡i...', 'info');
            const detailResult = await apiRequest(`/de-thi/${maDe}/detail`, 'GET');

            if (!detailResult.ok) {
                log('âŒ KhÃ´ng thá»ƒ láº¥y thÃ´ng tin Ä‘á» thi!', 'error');
                return;
            }

            const currentExam = detailResult.data.data.exam;
            log(`âœ… Äá» thi hiá»‡n táº¡i:`, 'success');
            log(`  - TÃªn: ${currentExam.TenDe}`, 'success');
            log(`  - Chá»§ Ä‘á»: ${currentExam.ChuDe}`, 'success');
            log(`  - Thá»i gian: ${currentExam.ThoiGianLamBai} phÃºt`, 'success');
            log(`  - Tráº¡ng thÃ¡i: ${currentExam.TrangThai}`, 'success');

            // BÆ°á»›c 2: Update Ä‘á» thi
            log('â†’ BÆ°á»›c 2.2: Gá»­i yÃªu cáº§u cáº­p nháº­t...', 'info');
            const updateBody = {
                TenDe: tenDeMoi,
                ChuDe: chuDe || currentExam.ChuDe,
                ThoiGianLamBai: parseInt(thoiGian),
                MoTa: 'ÄÃ£ Ä‘Æ°á»£c cáº­p nháº­t qua debug tool',
                TrangThai: 1
            };

            const updateResult = await apiRequest(`/de-thi/${maDe}`, 'PUT', updateBody);

            if (updateResult.ok) {
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
                log('âœ… Sá»¬A Äá»€ THI THÃ€NH CÃ”NG!', 'success');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'success');
                log(`â†’ TÃªn má»›i: ${tenDeMoi}`, 'success');
                log(`â†’ Thá»i gian má»›i: ${thoiGian} phÃºt`, 'success');
                if (chuDe) log(`â†’ Chá»§ Ä‘á» má»›i: ${chuDe}`, 'success');
            } else {
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'error');
                log('âŒ Sá»¬A Äá»€ THI THáº¤T Báº I!', 'error');
                log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'error');
                if (updateResult.data && updateResult.data.message) {
                    log(`â†’ Lá»—i: ${updateResult.data.message}`, 'error');
                }
            }
        }
    </script>
</body>
</html>
