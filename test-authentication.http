### ===============================================
### AUTHENTICATION API TESTS - COMPLETE FLOW
### UR-01: Module Quáº£n lÃ½ Chung vÃ  TÃ i khoáº£n
### ===============================================

@baseUrl = http://localhost:8000/api

### ===============================================
### 1. UR-01.2: ÄÄ‚NG KÃ TÃ€I KHOáº¢N (REGISTER)
### ===============================================

### 1.1 ÄÄƒng kÃ½ tÃ i khoáº£n má»›i (Student self-registration)
POST {{baseUrl}}/register
Content-Type: application/json

{
  "TenDangNhap": "newstudent123",
  "Email": "newstudent@example.com",
  "MatKhau": "password123",
  "HoTen": "Nguyá»…n VÄƒn Test",
  "Lop": "12A1",
  "Truong": "THPT Nguyá»…n Huá»‡"
}

### Expected: 201 Created
### Response: {
###   "success": true,
###   "message": "ÄÄƒng kÃ½ tÃ i khoáº£n thÃ nh cÃ´ng!",
###   "data": {
###     "token": "...",
###     "user": { ... },
###     "detail": { "MaHS": "HS...", ... }
###   }
### }

### 1.2 ÄÄƒng kÃ½ vá»›i username Ä‘Ã£ tá»“n táº¡i (Should fail)
POST {{baseUrl}}/register
Content-Type: application/json

{
  "TenDangNhap": "newstudent123",
  "Email": "another@example.com",
  "MatKhau": "password123",
  "HoTen": "Test Duplicate"
}

### Expected: 422 Validation Error
### Error: "TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i"

### 1.3 ÄÄƒng kÃ½ vá»›i email Ä‘Ã£ tá»“n táº¡i (Should fail)
POST {{baseUrl}}/register
Content-Type: application/json

{
  "TenDangNhap": "anotheruser",
  "Email": "newstudent@example.com",
  "MatKhau": "password123",
  "HoTen": "Test Duplicate Email"
}

### Expected: 422 Validation Error
### Error: "Email Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng"

### 1.4 ÄÄƒng kÃ½ vá»›i máº­t kháº©u yáº¿u (< 6 kÃ½ tá»±)
POST {{baseUrl}}/register
Content-Type: application/json

{
  "TenDangNhap": "weakpass",
  "Email": "weak@example.com",
  "MatKhau": "123",
  "HoTen": "Weak Password Test"
}

### Expected: 422 Validation Error
### Error: "Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±"

### 1.5 ÄÄƒng kÃ½ vá»›i dá»¯ liá»‡u Ä‘áº§y Ä‘á»§
POST {{baseUrl}}/register
Content-Type: application/json

{
  "TenDangNhap": "fulldata456",
  "Email": "fulldata@example.com",
  "MatKhau": "securepass123",
  "HoTen": "Tráº§n Thá»‹ Full Data",
  "Lop": "12B2",
  "Truong": "THPT LÃª QuÃ½ ÄÃ´n"
}

### Expected: 201 Created
### Auto-login: Token returned

### ===============================================
### 2. UR-01.1: ÄÄ‚NG NHáº¬P (LOGIN) - Already exists
### ===============================================

### 2.1 ÄÄƒng nháº­p vá»›i tÃ i khoáº£n má»›i Ä‘Äƒng kÃ½
POST {{baseUrl}}/login
Content-Type: application/json

{
  "TenDangNhap": "newstudent123",
  "MatKhau": "password123"
}

### Expected: 200 OK
### Response: Token + User info

### 2.2 ÄÄƒng nháº­p vá»›i tÃ i khoáº£n admin
POST {{baseUrl}}/login
Content-Type: application/json

{
  "TenDangNhap": "admin",
  "MatKhau": "admin123456"
}

### Save token for later tests
@adminToken = {{login.response.body.$.data.token}}

### ===============================================
### 3. UR-01.3: KHÃ”I PHá»¤C Máº¬T KHáº¨U (FORGOT PASSWORD)
### ===============================================

### 3.1 Gá»­i yÃªu cáº§u khÃ´i phá»¥c vá»›i email há»£p lá»‡
POST {{baseUrl}}/forgot-password
Content-Type: application/json

{
  "Email": "newstudent@example.com"
}

### Expected: 200 OK
### Response: {
###   "success": true,
###   "message": "MÃ£ khÃ´i phá»¥c máº­t kháº©u Ä‘Ã£ Ä‘Æ°á»£c gá»­i Ä‘áº¿n email cá»§a báº¡n",
###   "reset_code": 123456  (DEV ONLY - Ä‘á»ƒ test)
### }
### CHECK LOG: storage/logs/laravel.log Ä‘á»ƒ láº¥y mÃ£

### 3.2 Gá»­i yÃªu cáº§u vá»›i email khÃ´ng tá»“n táº¡i (Should fail)
POST {{baseUrl}}/forgot-password
Content-Type: application/json

{
  "Email": "notexist@example.com"
}

### Expected: 422 Validation Error
### Error: "Email khÃ´ng tá»“n táº¡i trong há»‡ thá»‘ng"

### 3.3 Gá»­i yÃªu cáº§u vá»›i email khÃ´ng Ä‘Ãºng format
POST {{baseUrl}}/forgot-password
Content-Type: application/json

{
  "Email": "invalid-email-format"
}

### Expected: 422 Validation Error
### Error: "Email khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng"

### 3.4 Gá»­i yÃªu cáº§u khÃ´i phá»¥c láº§n 2 (Overwrite token)
POST {{baseUrl}}/forgot-password
Content-Type: application/json

{
  "Email": "newstudent@example.com"
}

### Expected: 200 OK
### Old token will be replaced

### ===============================================
### 4. UR-01.3: Äáº¶T Láº I Máº¬T KHáº¨U (RESET PASSWORD)
### ===============================================

### 4.1 Äáº·t láº¡i máº­t kháº©u vá»›i mÃ£ há»£p lá»‡
### NOTE: Láº¥y reset_code tá»« response cá»§a forgot-password (hoáº·c log)
POST {{baseUrl}}/reset-password
Content-Type: application/json

{
  "Email": "newstudent@example.com",
  "ResetCode": "123456",
  "MatKhauMoi": "newpassword123",
  "XacNhanMatKhau": "newpassword123"
}

### Expected: 200 OK
### Response: {
###   "success": true,
###   "message": "Äáº·t láº¡i máº­t kháº©u thÃ nh cÃ´ng! Báº¡n cÃ³ thá»ƒ Ä‘Äƒng nháº­p báº±ng máº­t kháº©u má»›i"
### }

### 4.2 Äáº·t láº¡i vá»›i mÃ£ khÃ´ng Ä‘Ãºng (Should fail)
POST {{baseUrl}}/reset-password
Content-Type: application/json

{
  "Email": "newstudent@example.com",
  "ResetCode": "999999",
  "MatKhauMoi": "anotherpass",
  "XacNhanMatKhau": "anotherpass"
}

### Expected: 400 Bad Request
### Error: "MÃ£ khÃ´i phá»¥c khÃ´ng Ä‘Ãºng"

### 4.3 Äáº·t láº¡i vá»›i xÃ¡c nháº­n máº­t kháº©u khÃ´ng khá»›p
POST {{baseUrl}}/reset-password
Content-Type: application/json

{
  "Email": "newstudent@example.com",
  "ResetCode": "123456",
  "MatKhauMoi": "newpassword",
  "XacNhanMatKhau": "differentpassword"
}

### Expected: 422 Validation Error
### Error: "XÃ¡c nháº­n máº­t kháº©u khÃ´ng khá»›p"

### 4.4 Äáº·t láº¡i vá»›i máº­t kháº©u yáº¿u (< 6 kÃ½ tá»±)
POST {{baseUrl}}/reset-password
Content-Type: application/json

{
  "Email": "newstudent@example.com",
  "ResetCode": "123456",
  "MatKhauMoi": "123",
  "XacNhanMatKhau": "123"
}

### Expected: 422 Validation Error
### Error: "Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 6 kÃ½ tá»±"

### 4.5 Sá»­ dá»¥ng token Ä‘Ã£ dÃ¹ng rá»“i (Should fail - token bá»‹ xÃ³a)
POST {{baseUrl}}/reset-password
Content-Type: application/json

{
  "Email": "newstudent@example.com",
  "ResetCode": "123456",
  "MatKhauMoi": "tryagain",
  "XacNhanMatKhau": "tryagain"
}

### Expected: 404 Not Found
### Error: "KhÃ´ng tÃ¬m tháº¥y yÃªu cáº§u khÃ´i phá»¥c máº­t kháº©u cho email nÃ y"

### ===============================================
### 5. VERIFY Máº¬T KHáº¨U Má»šI (LOGIN WITH NEW PASSWORD)
### ===============================================

### 5.1 ÄÄƒng nháº­p vá»›i máº­t kháº©u cÅ© (Should fail)
POST {{baseUrl}}/login
Content-Type: application/json

{
  "TenDangNhap": "newstudent123",
  "MatKhau": "password123"
}

### Expected: 401 Unauthorized
### Error: "TÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng"

### 5.2 ÄÄƒng nháº­p vá»›i máº­t kháº©u má»›i (Should work)
POST {{baseUrl}}/login
Content-Type: application/json

{
  "TenDangNhap": "newstudent123",
  "MatKhau": "newpassword123"
}

### Expected: 200 OK
### Response: Token + User info

### ===============================================
### 6. INTEGRATION TESTS
### ===============================================

### 6.1 Full Flow: Register â†’ Forgot â†’ Reset â†’ Login
### Step 1: Register new account
POST {{baseUrl}}/register
Content-Type: application/json

{
  "TenDangNhap": "flowtest123",
  "Email": "flowtest@example.com",
  "MatKhau": "initialpass",
  "HoTen": "Flow Test User"
}

### Step 2: Request password reset
POST {{baseUrl}}/forgot-password
Content-Type: application/json

{
  "Email": "flowtest@example.com"
}

### Step 3: Reset password (get code from log)
POST {{baseUrl}}/reset-password
Content-Type: application/json

{
  "Email": "flowtest@example.com",
  "ResetCode": "GET_FROM_LOG",
  "MatKhauMoi": "resetpass123",
  "XacNhanMatKhau": "resetpass123"
}

### Step 4: Login with new password
POST {{baseUrl}}/login
Content-Type: application/json

{
  "TenDangNhap": "flowtest123",
  "MatKhau": "resetpass123"
}

### ===============================================
### 7. SECURITY TESTS
### ===============================================

### 7.1 Verify password is hashed (Check database)
### Query: SELECT MatKhau FROM TaiKhoan WHERE TenDangNhap = 'newstudent123';
### Expected: $2y$10$... (BCrypt hash, not plain text)

### 7.2 Verify reset token is hashed (Check password_resets table)
### Query: SELECT token FROM password_resets WHERE email = 'newstudent@example.com';
### Expected: $2y$10$... (BCrypt hash)

### 7.3 Verify token expiration (15 minutes)
### Wait 16 minutes after forgot-password, then try reset
### Expected: 400 "MÃ£ khÃ´i phá»¥c Ä‘Ã£ háº¿t háº¡n"

### 7.4 Verify one-time use token
### Use same reset code twice
### Expected: First success, second fail (404 token not found)

### ===============================================
### 8. EDGE CASES
### ===============================================

### 8.1 Register vá»›i fields bá»‹ thiáº¿u
POST {{baseUrl}}/register
Content-Type: application/json

{
  "TenDangNhap": "incomplete"
}

### Expected: 422 with multiple validation errors

### 8.2 Forgot password vá»›i empty email
POST {{baseUrl}}/forgot-password
Content-Type: application/json

{
  "Email": ""
}

### Expected: 422 "Email khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng"

### 8.3 Reset password vá»›i code khÃ´ng Ä‘Ãºng format (not 6 digits)
POST {{baseUrl}}/reset-password
Content-Type: application/json

{
  "Email": "test@example.com",
  "ResetCode": "abc123",
  "MatKhauMoi": "newpass",
  "XacNhanMatKhau": "newpass"
}

### Expected: 422 "MÃ£ khÃ´i phá»¥c pháº£i lÃ  6 chá»¯ sá»‘"

### ===============================================
### 9. PERFORMANCE TESTS (Manual)
### ===============================================

### 9.1 Multiple registrations (Check auto-increment IDs)
### Register 5 accounts and verify:
### - MaTK: TK001, TK002, TK003, TK004, TK005
### - MaHS: HS001, HS002, HS003, HS004, HS005

### 9.2 Concurrent forgot-password requests
### Send multiple requests for same email
### Expected: Last request overwrites previous token

### ===============================================
### SUMMARY
### ===============================================

### âœ… Implemented Features:
### - UR-01.1: Login (Already existed)
### - UR-01.2: Self-registration for students
### - UR-01.3: Forgot password (6-digit code)
### - UR-01.3: Reset password with token
### - Auto-generation: MaTK, MaHS
### - Password hashing (BCrypt)
### - Token expiration (15 minutes)
### - One-time use tokens
### - Auto-login after registration

### âœ… Security Features:
### - Password hashing (UR-05.3)
### - Token hashing
### - Token expiration
### - One-time token usage
### - Email validation
### - Password strength validation

### ğŸ“ TODO:
### - Configure SMTP for real email sending
### - Add rate limiting (prevent spam)
### - Add email templates
### - Add CAPTCHA for forgot-password
### - Frontend UI for register/forgot/reset

### ğŸ§ª Test Coverage:
### - âœ… Valid registration
### - âœ… Duplicate username/email
### - âœ… Weak password
### - âœ… Valid forgot password
### - âœ… Invalid email
### - âœ… Valid reset
### - âœ… Invalid reset code
### - âœ… Password mismatch
### - âœ… Token expiration
### - âœ… One-time token
### - âœ… Login with new password
